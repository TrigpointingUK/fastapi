#!/bin/bash

# Script to connect to RDS master user using the managed secret

set -e

AWS_REGION="{{ aws_region }}"
AWS_SECRET="{{ db_secret_name }}"

echo "================================================"
echo "fastapi-db RDS Master Connection"
echo "================================================"

# Retrieve credentials from Secrets Manager
echo "üîê Retrieving master credentials from AWS Secrets Manager..."
MASTER_JSON=$(aws secretsmanager get-secret-value \
  --secret-id "$AWS_SECRET" \
  --region "$AWS_REGION" \
  --query SecretString \
  --output text)

if [[ $? -ne 0 ]]; then
    echo "‚ùå Failed to retrieve master credentials from AWS Secrets Manager"
    echo "   Make sure AWS CLI is configured and you have permissions to access the secret"
    exit 1
fi

# Parse master credentials from JSON
DB_HOST="{{ db_host }}"
DB_PORT="{{ db_port }}"
DB_USER=$(echo "$MASTER_JSON" | jq -r '.username')
DB_PASS=$(echo "$MASTER_JSON" | jq -r '.password')
DB_NAME="{{ db_schema }}"

echo "üìä RDS connection details:"
echo "   Host: $DB_HOST"
echo "   Port: $DB_PORT"
echo "   Username: $DB_USER"
echo "   Schema: $DB_NAME"
echo ""
echo "üîå Connecting to database as master user..."
echo "================================================"

# Connect to database as master user
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME"
