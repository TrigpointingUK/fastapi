# MediaWiki Deployment Guide

This document outlines the MediaWiki deployment on AWS ECS for TrigpointingUK.

## Overview

MediaWiki runs as an ECS Fargate service in the `common` infrastructure, accessible at `wiki.trigpointing.uk`. It uses:
- Custom Docker image with OpenID Connect and AWS S3 extensions
- Shared RDS MySQL instance (dedicated `mediawiki` database)
- AWS Secrets Manager for configuration and credentials
- CloudFlare CDN and AWS ALB for traffic routing

## Architecture

```
CloudFlare (wiki.trigpointing.uk)
  ↓ HTTPS
AWS ALB (priority 124 listener rule)
  ↓ HTTP
ECS Fargate Task (common environment)
  ├─ MediaWiki container (port 80)
  ├─ LocalSettings.php (mounted from Secrets Manager)
  └─ Database connection to RDS MySQL
```

## Infrastructure Components

### 1. Docker Image
- **Repository**: `ghcr.io/ianh/fastapi/mediawiki`
- **Build**: Automated via `.github/workflows/mediawiki-build.yml`
- **Tags**: `develop`, `main`, `latest`
- **Location**: `/wiki/Dockerfile`

### 2. ECS Service
- **Cluster**: `trigpointing-cluster`
- **Service**: `trigpointing-mediawiki-common`
- **Task Definition**: `trigpointing-mediawiki-common`
- **Resources**: 512 CPU, 1024 MB memory
- **Autoscaling**: 1-3 tasks based on CPU/memory
- **Network**: Private subnets, no public IP
- **Terraform**: `/terraform/common/mediawiki.tf`

### 3. Database
- **Schema**: `mediawiki`
- **User**: `mediawiki_user`
- **Created by**: `/terraform/mysql/rds-schemas.tf`
- **Credentials**: AWS Secrets Manager (`trigpointing-mediawiki-credentials`)

### 4. Secrets
- **LocalSettings.php**: `trigpointing-mediawiki-localsettings`
  - Lifecycle: ignore_changes (manually managed)
  - Format: Plain text PHP file
- **Database Credentials**: `trigpointing-mediawiki-credentials`
  - Auto-generated by Terraform
  - Format: JSON with username, password, host, port, dbname

### 5. Load Balancer
- **Target Group**: `trigpointing-mediawiki-ecs-tg`
- **Health Check**: `GET /` expecting 200, 301, or 302
- **Listener Rule**: Priority 124, host header `wiki.trigpointing.uk`

### 6. DNS
- **Domain**: `wiki.trigpointing.uk`
- **Type**: CNAME to ALB
- **Managed by**: CloudFlare (proxied)

### 7. S3 Storage
- **Bucket**: `trigpointinguk-wiki`
- **Purpose**: MediaWiki file uploads and attachments
- **Features**: Versioning enabled, encrypted at rest (AES256)
- **Access**: Read/write from MediaWiki ECS task via IAM role
- **Lifecycle**: Old versions expire after 90 days
- **CORS**: Configured for `https://wiki.trigpointing.uk`

## Deployment Steps

### Prerequisites

1. **GitHub Secrets** (if not already configured):
   ```bash
   # These should already be set for the FastAPI deployment
   AWS_ACCESS_KEY_ID
   AWS_SECRET_ACCESS_KEY
   ```

2. **Terraform State**:
   - Common infrastructure: `s3://tuk-terraform-state/fastapi-common-eu-west-1/terraform.tfstate`
   - MySQL infrastructure: `s3://tuk-terraform-state/fastapi-mysql-eu-west-1/terraform.tfstate`

### Step 1: Deploy MySQL Resources

```bash
cd terraform/mysql
terraform init -backend-config=backend.conf
terraform plan
terraform apply

# Note the output: mediawiki_credentials_arn
```

This creates:
- `mediawiki` database schema
- `mediawiki_user` MySQL user with full permissions
- AWS Secrets Manager secret with database credentials

### Step 2: Deploy Common Infrastructure

```bash
cd terraform/common
terraform init -backend-config=backend.conf
terraform plan
terraform apply
```

This creates:
- ECS task definition and service
- Security groups
- ALB target group and listener rule
- LocalSettings.php secret (with placeholder content)

### Step 3: Prepare LocalSettings.php

Create your `LocalSettings.php` file based on your legacy MediaWiki installation. Key changes needed:

```php
<?php
# Database settings
$wgDBserver = getenv('MEDIAWIKI_DB_HOST');
$wgDBname = "mediawiki";
$wgDBuser = "mediawiki_user";
$wgDBpassword = "PASSWORD_FROM_SECRETS_MANAGER";

# S3 Configuration (using AWS S3 extension with IAM role)
wfLoadExtension('AWS');
# Use IAM role credentials (already configured in ECS task)
$wgAWSCredentials = false; // Use IAM role
$wgAWSRegion = getenv('AWS_REGION') ?: 'eu-west-1';
$wgAWSBucketName = getenv('AWS_S3_BUCKET') ?: 'trigpointinguk-wiki';

# OpenID Connect Configuration (if using OIDC)
wfLoadExtension('PluggableAuth');
wfLoadExtension('OpenIDConnect');
$wgPluggableAuth_Config = [
    // Your OIDC config here
];
```

### Step 4: Upload LocalSettings.php

```bash
# Option 1: Using AWS CLI
aws secretsmanager update-secret \
  --secret-id trigpointing-mediawiki-localsettings \
  --secret-string file://LocalSettings.php \
  --region eu-west-1

# Option 2: Using AWS Console
# Navigate to Secrets Manager → trigpointing-mediawiki-localsettings
# Click "Retrieve secret value" → "Edit"
# Paste your LocalSettings.php content
# Save
```

### Step 5: Build and Push Docker Image

```bash
# Commit your Dockerfile changes to develop
git add wiki/
git commit -m "Add MediaWiki Docker configuration"
git push origin develop

# GitHub Actions will automatically build and push the image
# Monitor: https://github.com/ianh/fastapi/actions
```

### Step 6: Deploy to Production

```bash
# Merge develop to main
git checkout main
git merge develop
git push origin main

# GitHub Actions will:
# 1. Build and push the image with 'main' and 'latest' tags
# 2. Update the ECS service to use the new image
```

## Maintenance

### Updating LocalSettings.php

```bash
# Update the secret
aws secretsmanager update-secret \
  --secret-id trigpointing-mediawiki-localsettings \
  --secret-string file://LocalSettings.php \
  --region eu-west-1

# Restart ECS service to pick up changes
aws ecs update-service \
  --cluster trigpointing-cluster \
  --service trigpointing-mediawiki-common \
  --force-new-deployment \
  --region eu-west-1
```

### Scaling

Autoscaling is configured for 1-3 tasks based on CPU and memory:
- **Min**: 1 task (always running)
- **Max**: 3 tasks
- **CPU target**: 70%
- **Memory target**: 80%

To manually adjust:
```bash
aws ecs update-service \
  --cluster trigpointing-cluster \
  --service trigpointing-mediawiki-common \
  --desired-count 2 \
  --region eu-west-1
```

### Viewing Logs

```bash
# View CloudWatch logs
aws logs tail /aws/ecs/trigpointing-mediawiki-common --follow

# Or use AWS Console:
# CloudWatch → Log groups → /aws/ecs/trigpointing-mediawiki-common
```

### Database Access

```bash
# Get database credentials
aws secretsmanager get-secret-value \
  --secret-id trigpointing-mediawiki-credentials \
  --region eu-west-1 \
  | jq -r '.SecretString'

# Connect via bastion host
ssh bastion.trigpointing.uk
mysql -h <rds-endpoint> -u mediawiki_user -p mediawiki
```

## Additional Considerations

### Things You May Have Forgotten

1. **S3 Bucket for Uploads** ✅ CREATED
   - S3 bucket: `trigpointinguk-wiki`
   - IAM permissions: Configured for ECS task role (read/write access)
   - Environment variables: `AWS_S3_BUCKET` and `AWS_REGION` automatically set
   - Update LocalSettings.php to use the AWS S3 extension with bucket name

2. **IAM Permissions for ECS Task**
   - If using S3: Add S3 read/write permissions to ECS task role
   - If using SES: Add SES permissions for email notifications
   - Update `terraform/common/ecs.tf` task role policy

3. **Email Configuration**
   - Configure SMTP or AWS SES for email notifications
   - Update LocalSettings.php with email settings

4. **Backup Strategy**
   - Database: RDS automated backups (7-day retention)
   - Files: S3 versioning if using S3 extension
   - LocalSettings.php: Versioned in Secrets Manager
   - Consider weekly manual exports

5. **SSL Certificate**
   - CloudFlare handles SSL termination
   - ALB uses Cloudflare origin certificates
   - No additional cert needed for wiki.trigpointing.uk

6. **Cache Configuration**
   - Consider adding ElastiCache (Redis/Memcached) for MediaWiki caching
   - Update LocalSettings.php with cache configuration
   - Will significantly improve performance

7. **File Upload Limits**
   - Current PHP limits in base MediaWiki image
   - Consider overriding in Dockerfile if needed:
     ```dockerfile
     RUN echo "upload_max_filesize = 20M" >> /usr/local/etc/php/conf.d/uploads.ini \
      && echo "post_max_size = 20M" >> /usr/local/etc/php/conf.d/uploads.ini
     ```

8. **Extensions Configuration**
   - OpenIDConnect: Requires Auth0 or other OIDC provider setup
   - AWS S3: Requires bucket and IAM configuration
   - Test all extensions after deployment

9. **MediaWiki Maintenance Tasks**
   - Consider scheduling maintenance scripts (e.g., `update.php`)
   - Could use ECS scheduled tasks or Lambda functions
   - Important after MediaWiki updates

10. **Database Migration**
    - If migrating from legacy wiki:
      - Export old database: `mysqldump old_wiki > wiki.sql`
      - Import to new schema: `mysql -h <rds> -u mediawiki_user -p mediawiki < wiki.sql`
      - Run MediaWiki update script
      - Test thoroughly before switching DNS

11. **Monitoring and Alerting**
    - ECS task health checks
    - ALB target health metrics
    - CloudWatch alarms for service failures
    - Consider adding to existing monitoring infrastructure

12. **Cost Optimization**
    - Current config: 1 task always running (~$15-20/month)
    - Consider scale-to-zero if low traffic (min_capacity = 0)
    - Monitor RDS costs - may need right-sizing
    - S3 costs if using upload storage

## Troubleshooting

### Container Won't Start
```bash
# Check ECS task logs
aws ecs describe-tasks \
  --cluster trigpointing-cluster \
  --tasks $(aws ecs list-tasks --cluster trigpointing-cluster --service-name trigpointing-mediawiki-common --query 'taskArns[0]' --output text) \
  --region eu-west-1

# Check CloudWatch logs
aws logs tail /aws/ecs/trigpointing-mediawiki-common --follow
```

### Database Connection Errors
- Verify security group allows traffic from MediaWiki ECS tasks
- Check database credentials in Secrets Manager
- Verify RDS instance is running

### LocalSettings.php Not Loading
- Verify secret name matches task definition
- Check ECS task execution role has permission to read secret
- Ensure secret contains valid PHP code

## References

- [MediaWiki Docker Official Image](https://hub.docker.com/_/mediawiki)
- [MediaWiki Installation Guide](https://www.mediawiki.org/wiki/Manual:Installation_guide)
- [OpenIDConnect Extension](https://www.mediawiki.org/wiki/Extension:OpenIDConnect)
- [AWS S3 Extension](https://github.com/edwardspec/mediawiki-aws-s3)
