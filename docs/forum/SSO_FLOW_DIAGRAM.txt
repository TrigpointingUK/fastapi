╔══════════════════════════════════════════════════════════════════════════════╗
║                     Auth0 SSO Enforcement Flow Diagram                       ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ Normal User Login Flow (Forced to Auth0)                                    │
└─────────────────────────────────────────────────────────────────────────────┘

   User clicks "Login" on forum
          │
          ├─ [Layer 1: JavaScript]
          │  └─→ Link already rewritten to:
          │      ucp.php?mode=login&login=external&oauth_service=auth0
          │
          ├─ [Layer 2: Apache Redirect] (if JS failed)
          │  └─→ RewriteRule catches mode=login
          │      Redirects to: login=external&oauth_service=auth0
          │
          ├─ [Layer 3: PHP Redirect] (if Apache failed)
          │  └─→ on_page_header() catches login page load
          │      Redirects to: login=external&oauth_service=auth0
          │
          └─ [Layer 4: CSS Hide] (if all redirects failed)
             └─→ Username/password form hidden by CSS
                 Only OAuth button visible

          ↓

   User redirected to Auth0
          │
          ├─→ User logs in with Google/Facebook/Email/etc.
          │
          └─→ Auth0 redirects back to forum with OAuth token

          ↓

   phpBB OAuth handler processes token
          │
          ├─→ Checks if oauth_accounts mapping exists
          │   ├─ YES → Log in as existing user
          │   └─ NO  → Check if email matches existing user
          │            ├─ YES → Link accounts, log in
          │            └─ NO  → Create new user, log in
          │
          └─→ User logged in and redirected to destination


┌─────────────────────────────────────────────────────────────────────────────┐
│ Break-Glass Admin Login Flow (Emergency Access)                             │
└─────────────────────────────────────────────────────────────────────────────┘

   Admin navigates to: ucp.php?mode=login&local=1
          │
          ├─ [Layer 1: JavaScript]
          │  └─→ Detects local=1, skips rewrite
          │
          ├─ [Layer 2: Apache]
          │  └─→ RewriteCond checks for local=1, skips redirect
          │
          ├─ [Layer 3: PHP]
          │  └─→ on_page_header() detects local=1, skips redirect
          │
          └─ [Layer 4: CSS]
             └─→ Body class .local-login added
                 Username/password form shown

          ↓

   Admin sees traditional login form
          │
          └─→ Enters phpBB username/password

          ↓

   phpBB processes login normally
          │
          └─→ Admin logged in with phpBB credentials


┌─────────────────────────────────────────────────────────────────────────────┐
│ Blocked Actions                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

   User tries: ucp.php?mode=register
          │
          └─→ [Apache] Returns HTTP 403 Forbidden


   User tries: ucp.php?mode=sendpassword
          │
          └─→ [Apache] Returns HTTP 403 Forbidden


   User looks for "Register" or "Forgot password" links
          │
          └─→ [CSS] Links hidden: display: none !important


╔══════════════════════════════════════════════════════════════════════════════╗
║                         Implementation Layers                                 ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ Layer 1: JavaScript (Client-Side)                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Rewrites all login links on page load                                     │
│ • Respects ?local=1 and ?login=external                                     │
│ • Preserves redirect parameters                                             │
│ • Runs on every page via core.page_header event                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ Layer 2: Apache (Server-Side)                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Intercepts ucp.php?mode=login requests                                    │
│ • 302 redirect to Auth0 OAuth                                               │
│ • Skips redirect if ?local=1 or ?login=external present                     │
│ • Blocks registration and password reset (403 Forbidden)                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ Layer 3: PHP Event Listener (Application-Side)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Triggers on every page via core.page_header                               │
│ • Detects login page visits                                                 │
│ • Redirects to Auth0 unless ?local=1 present                                │
│ • Injects CSS and JavaScript into every page                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ Layer 4: CSS (Presentation-Side)                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Hides username/password forms                                             │
│ • Hides registration links                                                  │
│ • Hides password reset links                                                │
│ • Shows forms only when .local-login class present                          │
└─────────────────────────────────────────────────────────────────────────────┘


╔══════════════════════════════════════════════════════════════════════════════╗
║                            Security Features                                  ║
╚══════════════════════════════════════════════════════════════════════════════╝

✅ Defense in Depth          - 4 layers ensure SSO enforcement
✅ Break-Glass Access        - Emergency admin login with ?local=1
✅ No Password Storage       - Users don't have passwords in phpBB DB
✅ MFA Support              - Auth0 MFA applies to forum login
✅ Centralized Identity     - Single identity across all services
✅ No Social Engineering    - Can't reset passwords or register locally
✅ Auto Account Creation    - New users created on first Auth0 login
✅ Email-Based Linking      - Existing users linked automatically
✅ Blocks Registration      - No local account creation
✅ Blocks Password Reset    - No password recovery attacks


╔══════════════════════════════════════════════════════════════════════════════╗
║                           Configuration Points                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

Apache Config:    forum/apache/phpbb-auth0.conf
PHP Extension:    forum/ext/teasel/auth0/event/subscriber.php
OAuth Service:    auth.provider.oauth.service.auth0
Break-Glass URL:  ?local=1
