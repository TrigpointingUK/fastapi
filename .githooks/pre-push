#!/bin/bash
# Pre-push hook to enforce strict validation for main/develop branches
# To install: cp .githooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

set -e

# Get the current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
remote_name="$1"
remote_url="$2"

echo "ğŸ” Pre-push validation for branch: $current_branch"

# Check if pushing to protected branches
if [[ "$current_branch" == "main" || "$current_branch" == "develop" ]]; then
    echo "ğŸš¨ CRITICAL: Pushing to protected branch '$current_branch'"
    echo "ğŸ“‹ Running mandatory CI validation..."
    
    # Check if virtual environment is activated
    if [[ "$VIRTUAL_ENV" == "" ]]; then
        echo "âš ï¸  Virtual environment not activated. Activating..."
        if [[ -f "venv/bin/activate" ]]; then
            source venv/bin/activate
        else
            echo "âŒ Virtual environment not found. Please run: python3 -m venv venv && source venv/bin/activate && make install-dev"
            exit 1
        fi
    fi
    
    # Enforce strict CI validation
    echo "ğŸ§ª Running complete CI suite (required for $current_branch)..."
    if make ci; then
        echo "âœ… All CI checks passed! Push approved for $current_branch"
        
        # Additional check for main branch
        if [[ "$current_branch" == "main" ]]; then
            echo "âš ï¸  WARNING: Direct push to main branch detected!"
            echo "ğŸ“‹ Best practice: Use develop â†’ main via pull request"
            echo "â¸ï¸  Continue anyway? (y/N): "
            read -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                echo "ğŸ›‘ Push cancelled. Consider using: git checkout develop && git push"
                exit 1
            fi
        fi
        
    else
        echo "âŒ CI validation FAILED for protected branch '$current_branch'"
        echo ""
        echo "ğŸ”§ Required fixes before push:"
        echo "  1. Run: make ci"
        echo "  2. Fix all reported issues" 
        echo "  3. Auto-fix formatting: black app tests && isort app tests"
        echo "  4. Manual fix: flake8, mypy, test failures"
        echo "  5. Re-run: make ci (must pass completely)"
        echo ""
        echo "ğŸš« PUSH BLOCKED until all CI checks pass"
        exit 1
    fi
    
else
    echo "â„¹ï¸  Feature branch push detected. Skipping strict validation."
    echo "ğŸ’¡ Reminder: Run 'make ci' before merging to develop/main"
fi

echo "ğŸš€ Pre-push validation complete"
