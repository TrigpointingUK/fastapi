<link href="./styles/prosilver/theme/colours_green.css" rel="stylesheet" type="text/css" />
<link rel="icon" type="image/x-icon" href="./favicon.ico" />
<style>
/* Auth0 SSO Enforcement: Hide username/password login forms */
{% if not AUTH0_LOCAL_LOGIN %}
/* Hide the quick login form on homepage */
.headerspace form[action*="mode=login"],
form.quick-login,
.quick-login,
fieldset.quick-login { display: none !important; }

/* Hide username/password fields on login page */
#login_box,
.login-form fieldset.fields1 { display: none !important; }

/* Hide login panel on index */
.panel.login { display: none !important; }
{% endif %}

/* Always hide register and password reset links */
a[href*="mode=register"],
a[href*="mode=sendpassword"] { display: none !important; }
</style>

<script>
(function() {
    // Detect local=1 from URL directly since template variables may not be available in template events
    var isLocalLogin = window.location.search.indexOf('local=1') !== -1;

    // Wait for DOM
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }

    function init() {
        rewriteLoginLinks();
        if (isLocalLogin) {
            preserveLocalParam();
        }
        enforceAuth0OnProtectedPages();
    }

    function preserveLocalParam() {
        // Add local=1 to all login form actions
        document.querySelectorAll('form[action*="mode=login"]').forEach(function(form) {
            var action = form.getAttribute("action") || form.action;
            if (action && action.indexOf("local=1") === -1) {
                var separator = action.indexOf("?") !== -1 ? "&" : "?";
                form.action = action + separator + "local=1";
            }
        });
    }

    function rewriteLoginLinks() {
        if (isLocalLogin) return; // Don't rewrite in local mode

        // Find all login links and rewrite to Auth0
        document.querySelectorAll('a[href*="mode=login"]').forEach(function(link) {
            var href = link.getAttribute("href");
            if (!href || href.indexOf("login=external") !== -1 || href.indexOf("local=1") !== -1) {
                return;
            }

            var redirectMatch = href.match(/[?&]redirect=([^&]*)/);
            var redirect = redirectMatch ? redirectMatch[1] : "";

            var newHref = "ucp.php?mode=login&login=external&oauth_service=auth.provider.oauth.service.auth0";
            if (redirect) {
                newHref += "&redirect=" + redirect;
            }

            link.setAttribute("href", newHref);
        });
    }

    function enforceAuth0OnProtectedPages() {
        if (isLocalLogin) return; // allow break-glass

        // If a protected page shows a login form, auto-redirect to Auth0 preserving destination
        var loginForm = document.querySelector('form[action*="mode=login"], form#login, .login-form form');
        var protectedNotice = document.body && (document.body.textContent || '').indexOf('requires you to be registered and logged in') !== -1;
        if (!loginForm && !protectedNotice) return;

        // Compute redirect back to current path
        var path = window.location.pathname + (window.location.search || '');
        var redirect = encodeURIComponent(path.replace(/^\//, ''));
        var auth0Url = "ucp.php?mode=login&login=external&oauth_service=auth.provider.oauth.service.auth0&redirect=" + redirect;
        window.location.replace(auth0Url);
    }
})();
</script>
