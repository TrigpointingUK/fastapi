<Directory /var/www/html>
    # Enable .htaccess overrides and rewrites
    AllowOverride All
    Options -Indexes +FollowSymLinks

    <IfModule mod_rewrite.c>
    RewriteEngine On

    # Force SSO: send native login to Auth0 unless ?local=1 is present
    # Catches all mode=login requests and redirects to OAuth, preserving other query params
    RewriteCond %{QUERY_STRING} (^|&)mode=login(&|$) [NC]
    RewriteCond %{QUERY_STRING} !(^|&)local=1(&|$) [NC]
    RewriteCond %{QUERY_STRING} !(^|&)login=external(&|$) [NC]
    RewriteRule ^ucp\.php$ /ucp.php?mode=login&login=external&oauth_service=auth.provider.oauth.service.auth0&%{QUERY_STRING} [R=302,L,QSA]

    # Block local registration & password reset outright (change [F] to a redirect if you prefer)
    RewriteCond %{QUERY_STRING} (^|&)mode=(sendpassword|register)(&|$) [NC]
    RewriteRule ^ucp\.php$ - [F]
    </IfModule>
</Directory>
